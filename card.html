<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>診断結果プレゼント</title>
    <link href="https://fonts.googleapis.com/css2?family=Yu+Mincho:wght@700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { margin: 0; padding: 0; background-color: #111; color: #fff; font-family: "Yu Mincho", serif; }

        /* カードの土台（自作台紙 1600x1200用） */
        #source-container {
            position: absolute; top: 0; left: -2000px;
            width: 1600px; height: 1200px; 
            background-color: #000; overflow: hidden;
        }

        /* 1. 自作した台紙画像 */
        .wp-base-card { 
            position: absolute; top: 0; left: 0;
            width: 1600px; height: 1200px; z-index: 1;
        }

        /* 2. 都道府県の頭（位置は要調整） */
        .wp-head { 
            position: absolute; 
            top: 62px;  /* ←台紙の体の位置に合わせて調整 */
            left: 26px; /* ←台紙の体の位置に合わせて調整 */
            width: 315px; z-index: 5; 
        }

        /* 3. 称号・コンビ名（台紙の右側に配置） */
        .wp-combi-name { 
            position: absolute;
            top: 160px; right: 100px; width: 800px;
            font-size: 55px; color: #fff; text-shadow: 0 0 20px #04FF00;
            text-align: center; z-index: 10;
        }
        
        /* 4. グラフエリア（台紙の右側中央に配置） */
        .wp-chart-container { 
    position: absolute;
    top: 250px;  /* 位置も少し下げたほうがバランスいいかも */
    left: 850px; /* 右側に寄せ具合を調整 */
    width: 500px; /* 700pxから500pxに縮小 */
    height: 450px; /* 600pxから450pxに縮小 */
    display: flex; 
    justify-content: center; 
    align-items: center;
    z-index: 10;
}

        /* 実際にスマホで見えるエリア */
        .display-area { width: 100vw; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #final-image { width: 100%; max-width: 600px; border: 2px solid #04FF00; border-radius: 10px; display: none; }
        #status-msg { color: #04FF00; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="source-container">
        <img id="wp-base-img" class="wp-base-card">
        <img id="wp-head-img" class="wp-head">
        <div id="wp-combi-name" class="wp-combi-name"></div>
        <div class="wp-chart-container">
            <canvas id="cardRadarChart" width="500" height="450"></canvas>
        </div>
    </div>

    <div class="display-area">
        <img id="final-image" alt="結果証明カード">
        <p id="status-msg">カードを生成中...<br>（10秒ほどかかる場合があります）</p>
    </div>

    <script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const point = parseInt(urlParams.get('point') || '0', 10);
        const pref = urlParams.get('pref') || 'niigata';
        
        // 1. 画像とテキストの設定
        document.getElementById('wp-combi-name').innerText = urlParams.get('name') || '未知数の新コンビ';
        
        let baseSrc = 'images/card_c.png'; // 作成した台紙のファイル名に合わせてください
        if (point >= 9) baseSrc = 'images/card_s.png';
        else if (point >= 6) baseSrc = 'images/card_a.png';
        else if (point >= 3) baseSrc = 'images/card_b.png';
        
        const baseImg = document.getElementById('wp-base-img');
        const headImg = document.getElementById('wp-head-img');
        baseImg.src = baseSrc;
        headImg.src = `images/${pref}-head.png`;

        // 2. グラフ描画
        const ctx = document.getElementById('cardRadarChart');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['爆発力', ['阿吽の', '呼吸'], '包容力', ['ガチの', '絆'], '運命'],
                datasets: [{
                    data: [
                        urlParams.get('p') || 0, urlParams.get('t') || 0, urlParams.get('v') || 0,
                        urlParams.get('b') || 0, urlParams.get('d') || 0
                    ],
                    backgroundColor: 'rgba(4, 255, 0, 0.2)',
                    borderColor: '#04FF00', borderWidth: 4
                }]
            },
            options: {
                responsive: false,
                scales: {
                    r: {
                        min: 0, max: 40,
                        grid: { color: 'rgba(4, 255, 0, 0.4)', lineWidth: 2 },
                        angleLines: { color: 'rgba(4, 255, 0, 0.4)' },
                        pointLabels: { font: { 
                    size: 26, // 34から26へ縮小（お好みで24〜28あたりで調整）
                    weight: 'bold',
                    family: '"Yu Mincho", serif' // ここで明朝体を指定
                }, 
                color: '#04FF00', 
                padding: 15 },
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // 3. 全ての画像が読み込まれたらhtml2canvas実行
        let loadedCount = 0;
        [baseImg, headImg].forEach(img => {
            img.onload = () => {
                loadedCount++;
                if(loadedCount === 2) {
                    setTimeout(() => {
                        html2canvas(document.getElementById('source-container'), { 
                            width: 1600, height: 1200, scale: 1, useCORS: true,
                            backgroundColor: '#000'
                        }).then(canvas => {
                            const final = document.getElementById('final-image');
                            final.src = canvas.toDataURL("image/png");
                            final.style.display = 'block';
                            document.getElementById('status-msg').innerHTML = "カードが完成しました！<br>長押しして保存してください";
                        });
                    }, 2000);
                }
            };
        });
    };
    </script>
</body>
</html>