<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>診断結果プレゼント</title>
    <link href="https://fonts.googleapis.com/css2?family=Yu+Mincho:wght@700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { margin: 0; padding: 0; background-color: #111; color: #fff; font-family: "Yu Mincho", serif; }

        /* 【重要】カードの土台。画面には絶対に出さない */
        #source-container {
            position: absolute; top: 0; left: -2000px; /* 画面の左外に配置 */
            width: 1600px; height: 1200px; 
            display: flex; flex-direction: row; /* 横並びを強制 */
            background-color: #000; overflow: hidden;
        }

        /* 左側：画像エリア */
        .card-left { 
            width: 624px; height: 1200px; flex-shrink: 0; 
            position: relative; border-right: 4px solid #04FF00; 
        }
        .wp-bg { width: 100%; height: 100%; object-fit: cover; }
        .wp-head { position: absolute; top: 13%; left: 24%; width: 340px; transform: translate(-50%, -50%); z-index: 5; }

        /* 右側：情報エリア */
        .card-right { 
            flex-grow: 1; height: 1200px; 
            display: flex; flex-direction: column; align-items: center;
            padding: 50px; background: #050505; box-sizing: border-box;
        }
        .wp-card-title { font-size: 34px; color: #fff; border-bottom: 2px solid #04FF00; width: 100%; text-align: center; padding-bottom: 10px; margin-bottom: 20px; }
        .wp-combi-name { font-size: 50px; color: #fff; text-shadow: 0 0 20px #04FF00; text-align: center; margin-bottom: 20px; white-space: pre-wrap; }
        
        /* グラフが横に伸びないよう、コンテナを正方形に近い形に固定 */
    .wp-chart-container { 
        width: 600px;  /* 横幅を少し絞る */
        height: 550px; /* 高さをしっかり確保 */
        margin: 0 auto 30px auto; 
        display: block; 
        position: relative;
    }
        /* コメントが見切れないよう、高さを自動(min-height)にする */
    .wp-comment-container { 
        width: 100%; 
        min-height: 320px; /* 最低限の高さ */
        height: auto;      /* 内容に合わせて伸びるようにする */
        border: 4px solid #04FF00; 
        border-radius: 20px;
        padding: 40px; 
        background: rgba(0,0,0,0.8); 
        font-size: 32px; 
        line-height: 1.6;
        display: flex; 
        align-items: center; 
        box-sizing: border-box; /* パディングを含めたサイズ計算 */
    }
    
        /* 日付 */
        .wp-date { width: 100%; text-align: right; font-size: 26px; margin-top: 20px; }

        /* グラフのキャンバス自体のサイズが暴れないように固定 */
    #cardRadarChart {
        width: 600px !important;
        height: 550px !important;
    }

        /* 実際にスマホ画面に見えるエリア */
        .display-area { width: 100vw; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #final-image { width: 100%; max-width: 600px; border: 2px solid #04FF00; border-radius: 10px; display: none; }
        #status-msg { color: #04FF00; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="source-container">
        <div class="card-left">
            <img id="wp-bg-img" class="wp-bg">
            <img id="wp-head-img" class="wp-head">
        </div>
        <div class="card-right">
            <div class="wp-card-title">山形ツッコミオーディション 結果証明カード</div>
            <div id="wp-combi-name" class="wp-combi-name"></div>
            <div class="wp-chart-container">
                <canvas id="cardRadarChart" width="600" height="550"></canvas>
            </div>
            <div id="wp-comment" class="wp-comment-container">
                <span id="comment-text"></span>
            </div>
            <div id="wp-date" class="wp-date"></div>
        </div>
    </div>

    <div class="display-area">
        <img id="final-image" alt="結果証明カード">
        <p id="status-msg">カードを生成中...<br>（10秒ほどかかる場合があります）</p>
    </div>

    <script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // データの流し込み
        document.getElementById('wp-combi-name').innerText = urlParams.get('name') || '未知数の新コンビ';
        document.getElementById('comment-text').innerText = urlParams.get('comment') || '';
        
        const point = parseInt(urlParams.get('point') || '0', 10);
        const pref = urlParams.get('pref') || 'niigata';
        
        // グラフ描画
        const ctx = document.getElementById('cardRadarChart');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['爆発力', ['阿吽の', '呼吸'], '包容力', ['ガチの', '絆'], '運命'],
                datasets: [{
                    data: [
                        urlParams.get('p') || 0, urlParams.get('t') || 0, urlParams.get('v') || 0,
                        urlParams.get('b') || 0, urlParams.get('d') || 0
                    ],
                    backgroundColor: 'rgba(4, 255, 0, 0.2)',
                    borderColor: '#04FF00', borderWidth: 3, pointRadius: 5
                }]
            },
            options: {
            responsive: false,
            maintainAspectRatio: true, // これをtrueにすると歪まなくなります
            devicePixelRatio: 2,       // 解像度を上げてグラフをハッキリさせる
            scales: {
                r: {
                    min: 0, 
                    max: 40,
                    // グラフが小さすぎる場合は、ここを調整
                    // pointLabelsのpadding（文字とグラフの距離）を小さくするとグラフが広がります
                    pointLabels: { 
                        font: { size: 26, weight: 'bold' }, 
                        color: '#04FF00',
                        padding: 10 
                    }
                }
            },
            plugins: { legend: { display: false } }
        }
    });

        // 画像の読み込み完了を待ってから合成
        const bgImg = document.getElementById('wp-bg-img');
        const headImg = document.getElementById('wp-head-img');
        
        let bgLoaded = false; let headLoaded = false;
        const checkReady = () => {
            if(bgLoaded && headLoaded) {
                setTimeout(() => {
        html2canvas(document.getElementById('source-container'), { 
            scale: 1, 
            useCORS: true,
            width: 1600,
            height: 1200,
            scrollY: 0,
            scrollX: 0,
            windowWidth: 1600,
            windowHeight: 1200
        }).then(canvas => {
                        const final = document.getElementById('final-image');
                        final.src = canvas.toDataURL("image/png");
                        final.style.display = 'block';
                        document.getElementById('status-msg').innerHTML = "カードが完成しました！<br>長押しして保存してください";
                    });
                }, 2000);
            }
        };

        bgImg.onload = () => { bgLoaded = true; checkReady(); };
        headImg.onload = () => { headLoaded = true; checkReady(); };

        // 画像パス設定
        let bgSrc = 'images/result_c.png';
        if (point >= 9) bgSrc = 'images/result_s.png';
        else if (point >= 6) bgSrc = 'images/result_a.png';
        else if (point >= 3) bgSrc = 'images/result_b.png';
        bgImg.src = bgSrc;
        headImg.src = `images/${pref}-head.png`;
        
        const now = new Date();
        document.getElementById('wp-date').innerText = `${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()}`;
    };
    </script>
</body>
</html>